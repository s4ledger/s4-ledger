<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solus Protocol | Metrics & Network Activity</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #050608; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; }
        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
        .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(20,241,149,0.2); border-radius: 12px; padding: 32px; margin-bottom: 32px; }
        h1, h2, h3 { color: #14f195; }
        .nav-link { color: #9945ff; }
        .filter-btn { background: rgba(20,241,149,0.2); color: #14f195; border: 1px solid #14f195; border-radius: 6px; padding: 6px 12px; margin: 4px; cursor: pointer; transition: all 0.2s; }
        .filter-btn:hover { background: rgba(20,241,149,0.4); }
        .filter-btn.active { background: #14f195; color: #050608; font-weight: bold; }
        .stat-box { background: rgba(20,241,149,0.1); border: 1px solid rgba(20,241,149,0.3); border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: #14f195; }
        .stat-label { font-size: 0.9rem; color: #aaa; }
        .stat-delta { font-size: 0.85rem; color: #4CAF50; margin-top: 5px; }
        .stat-delta.positive::before { content: '+'; }
        .live-indicator { display: inline-flex; align-items: center; gap: 8px; background: rgba(20,241,149,0.15); padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; color: #14f195; }
        .live-dot { width: 8px; height: 8px; background: #14f195; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .filter-select { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(20,241,149,0.3); border-radius: 6px; padding: 8px 12px; margin-left: 10px; }
        .filter-select option { background: #111; color: #fff; }
        .export-btn { background: rgba(153,69,255,0.2); color: #9945ff; border: 1px solid #9945ff; border-radius: 6px; padding: 8px 16px; cursor: pointer; transition: all 0.2s; font-size: 0.85rem; }
        .export-btn:hover { background: rgba(153,69,255,0.4); }
        .source-footer { text-align: center; padding: 30px 20px; margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.1); color: #666; font-size: 0.85rem; }
        .recent-table { width: 100%; margin-top: 20px; overflow-x: auto; display: block; }
        .recent-table th { color: #14f195; padding: 10px; border-bottom: 1px solid rgba(20,241,149,0.3); text-align: left; white-space: nowrap; }
        .recent-table td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); white-space: nowrap; }
        .badge-type { background: #9945ff; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; }
        .refresh-info { color: #666; font-size: 0.8rem; margin-top: 10px; }
        @media (max-width: 768px) {
            h1 { font-size: 1.5rem !important; }
            .stat-value { font-size: 1.8rem; }
            .container { padding: 0 10px; }
            .d-flex.justify-content-between { flex-direction: column; align-items: flex-start !important; }
            .filter-btn { padding: 5px 8px; font-size: 0.75rem; }
            .card { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <h1 class="mb-0">Solus Protocol Metrics & Network Activity</h1>
            <div class="d-flex align-items-center gap-3">
                <span class="live-indicator"><span class="live-dot"></span> Live updating every 30s</span>
                <button class="export-btn" onclick="exportCSV()">ðŸ“¥ Export CSV</button>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-value" id="totalHashes">-</div>
                    <div class="stat-label">Total Hashes Anchored</div>
                    <div class="stat-delta positive" id="hashesToday">+0 today</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-value" id="totalFees">-</div>
                    <div class="stat-label">Total $SLS Fees</div>
                    <div class="stat-delta positive" id="feesToday">+$0 today</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-value" id="recordTypes">-</div>
                    <div class="stat-label">Record Types</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-value" id="thisMonth">-</div>
                    <div class="stat-label">Records This Month</div>
                    <div class="stat-delta positive" id="monthGrowth"></div>
                </div>
            </div>
        </div>
        <div class="card">
            <h2>Hash Anchoring Over Time</h2>
            <p style="color:#888;">Each bar represents hashes anchored during that time period</p>
            <div class="mb-3" id="hashBtns">
                <button class="filter-btn active" data-view="minute">Per Minute</button>
                <button class="filter-btn" data-view="hour">Per Hour</button>
                <button class="filter-btn" data-view="day">Daily</button>
                <button class="filter-btn" data-view="week">Weekly</button>
                <button class="filter-btn" data-view="month">Monthly</button>
            </div>
            <canvas id="hashChart" height="100"></canvas>
        </div>
        <div class="card">
            <h2>Records Secured Breakdown</h2>
            <p style="color:#888;">Distribution of record types anchored to XRPL
                <select class="filter-select" id="recordTypeFilter" onchange="filterByRecordType()">
                    <option value="all">All Record Types</option>
                </select>
            </p>
            <canvas id="recordChart" height="100"></canvas>
        </div>
        <div class="card">
            <h2>$SLS Fee Activity</h2>
            <p style="color:#888;">Fees collected per time period (0.01 $SLS per anchor)</p>
            <div class="mb-3" id="feeBtns">
                <button class="filter-btn active" data-view="minute">Per Minute</button>
                <button class="filter-btn" data-view="hour">Per Hour</button>
                <button class="filter-btn" data-view="day">Daily</button>
                <button class="filter-btn" data-view="week">Weekly</button>
                <button class="filter-btn" data-view="month">Monthly</button>
            </div>
            <canvas id="feeChart" height="100"></canvas>
        </div>
        <div class="card">
            <h2>XRPL Transaction Volume</h2>
            <p style="color:#888;">Number of transactions per time period</p>
            <div class="mb-3" id="txBtns">
                <button class="filter-btn active" data-view="minute">Per Minute</button>
                <button class="filter-btn" data-view="hour">Per Hour</button>
                <button class="filter-btn" data-view="day">Daily</button>
                <button class="filter-btn" data-view="week">Weekly</button>
                <button class="filter-btn" data-view="month">Monthly</button>
            </div>
            <canvas id="txChart" height="100"></canvas>
        </div>
        <div class="card">
            <h2>Recent Anchored Records</h2>
            <p style="color:#888;">Individual records with exact timestamps</p>
            <table class="recent-table">
                <thead><tr><th>Timestamp</th><th>Record Type</th><th>Hash (truncated)</th><th>Fee</th></tr></thead>
                <tbody id="recentBody"><tr><td colspan="4" style="text-align:center;color:#666;">Loading...</td></tr></tbody>
            </table>
            <p class="refresh-info">Auto-refreshes every 30 seconds</p>
        </div>
        <div class="text-center mt-5">
            <a href="transactions.html" class="nav-link">View Full XRPL Transactions</a><br><br>
            <a href="index.html" class="nav-link">Back to Solus Protocol Home</a>
        </div>
        <div class="source-footer">
            <p>ðŸ“¡ Data sourced from XRPL public ledger via account <a href="https://testnet.xrpl.org/accounts/rJPqcx8wUBM58ajPUoz1dReKkTT6hqrqJA" target="_blank" style="color:#14f195;font-family:monospace;">rJPqcx8w...qJA</a></p>
            <p style="margin-top:5px;">All metrics are real-time and verifiable on-chain. <a href="https://xrpl.org" target="_blank" style="color:#9945ff;">Learn about XRPL</a></p>
        </div>
    </div>
    <script>
        let metricsData = null;
        let hashChart, recordChart, feeChart, txChart;
        let currentHashView = 'minute', currentFeeView = 'minute', currentTxView = 'minute';
        let selectedRecordType = 'all';

        async function loadMetrics() {
            try {
                const response = await fetch('https://solusprotocol.onrender.com/metrics');
                metricsData = await response.json();
                document.getElementById('totalHashes').textContent = metricsData.total_hashes || 0;
                document.getElementById('totalFees').textContent = (metricsData.total_fees || 0).toFixed(2);
                document.getElementById('recordTypes').textContent = Object.keys(metricsData.records_by_type || {}).length;
                
                // Calculate today's stats
                const today = new Date().toLocaleDateString('en-US', { month: 'short', day: '2-digit' });
                const hashesToday = metricsData.hashes_by_day?.[today] || 0;
                const feesToday = metricsData.fees_by_day?.[today] || 0;
                document.getElementById('hashesToday').textContent = '+' + hashesToday + ' today';
                document.getElementById('feesToday').textContent = '+$' + feesToday.toFixed(2) + ' today';
                
                // Calculate this month's stats
                const monthYear = new Date().toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                const thisMonth = metricsData.hashes_by_month?.[monthYear] || 0;
                document.getElementById('thisMonth').textContent = thisMonth;
                
                // Populate record type filter
                const filterSelect = document.getElementById('recordTypeFilter');
                const types = Object.keys(metricsData.records_by_type || {});
                if (filterSelect.options.length <= 1) {
                    types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        filterSelect.appendChild(option);
                    });
                }
                
                renderHashChart(currentHashView);
                renderRecordChart();
                renderFeeChart(currentFeeView);
                renderTxChart(currentTxView);
                renderRecentTable();
            } catch (err) {
                console.error('Failed to load metrics:', err);
            }
        }

        function filterByRecordType() {
            selectedRecordType = document.getElementById('recordTypeFilter').value;
            renderRecentTable();
        }

        function exportCSV() {
            if (!metricsData || !metricsData.individual_records) {
                alert('No data available to export');
                return;
            }
            const records = metricsData.individual_records;
            const headers = ['Timestamp', 'Record Type', 'Hash', 'Fee ($SLS)', 'TX Hash'];
            const csvRows = [headers.join(',')];
            records.forEach(r => {
                csvRows.push([
                    '"' + r.timestamp_display + '"',
                    '"' + r.record_type + '"',
                    '"' + r.hash + '"',
                    r.fee,
                    '"' + (r.tx_hash || '') + '"'
                ].join(','));
            });
            const csvContent = csvRows.join('\\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'solus_protocol_metrics_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        function getDataForView(baseKey, view) {
            return metricsData[baseKey + '_by_' + view] || {};
        }

        function renderHashChart(view) {
            const data = getDataForView('hashes', view);
            const labels = Object.keys(data);
            const values = Object.values(data);
            const ctx = document.getElementById('hashChart').getContext('2d');
            if (hashChart) hashChart.destroy();
            hashChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels.length ? labels : ['No data'], datasets: [{ label: 'Hashes', data: values.length ? values : [0], backgroundColor: '#14f195', borderRadius: 4 }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#222' }, ticks: { color: '#888' } }, y: { grid: { color: '#222' }, ticks: { color: '#888', stepSize: 1 }, beginAtZero: true } } }
            });
        }

        function renderRecordChart() {
            const data = metricsData.records_by_type || {};
            const labels = Object.keys(data);
            const values = Object.values(data);
            const colors = ['#14f195', '#9945ff', '#ff4757', '#ffa502', '#3742fa', '#2ed573', '#ff6b81', '#70a1ff', '#eccc68', '#a29bfe', '#fd79a8', '#00cec9'];
            const ctx = document.getElementById('recordChart').getContext('2d');
            if (recordChart) recordChart.destroy();
            recordChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels.length ? labels : ['No records'], datasets: [{ data: values.length ? values : [1], backgroundColor: labels.length ? colors.slice(0, labels.length) : ['#333'], borderWidth: 0 }] },
                options: { responsive: true, plugins: { legend: { display: true, position: 'right', labels: { color: '#fff' } } } }
            });
        }

        function renderFeeChart(view) {
            const data = getDataForView('fees', view);
            const labels = Object.keys(data);
            const values = Object.values(data);
            const ctx = document.getElementById('feeChart').getContext('2d');
            if (feeChart) feeChart.destroy();
            feeChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels.length ? labels : ['No data'], datasets: [{ label: '$SLS Fees', data: values.length ? values : [0], borderColor: '#9945ff', backgroundColor: 'rgba(153,69,255,0.2)', fill: true, tension: 0.3, pointRadius: 6, pointBackgroundColor: '#9945ff' }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#222' }, ticks: { color: '#888' } }, y: { grid: { color: '#222' }, ticks: { color: '#888' }, beginAtZero: true } } }
            });
        }

        function renderTxChart(view) {
            const data = getDataForView('hashes', view);
            const labels = Object.keys(data);
            const values = Object.values(data);
            const ctx = document.getElementById('txChart').getContext('2d');
            if (txChart) txChart.destroy();
            txChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels.length ? labels : ['No data'], datasets: [{ label: 'Transactions', data: values.length ? values : [0], borderColor: '#ff4757', backgroundColor: 'rgba(255,71,87,0.2)', fill: true, tension: 0.3, pointRadius: 6, pointBackgroundColor: '#ff4757' }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#222' }, ticks: { color: '#888' } }, y: { grid: { color: '#222' }, ticks: { color: '#888', stepSize: 1 }, beginAtZero: true } } }
            });
        }

        function renderRecentTable() {
            let records = metricsData.individual_records || [];
            const tbody = document.getElementById('recentBody');
            if (records.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#666;">No records found</td></tr>'; return; }
            // Apply record type filter
            if (selectedRecordType !== 'all') {
                records = records.filter(r => r.record_type === selectedRecordType);
            }
            const recentRecords = [...records].reverse().slice(0, 20);
            if (recentRecords.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#666;">No records for selected type</td></tr>'; return; }
            tbody.innerHTML = recentRecords.map(r => '<tr><td style="color:#14f195;">' + r.timestamp_display + '</td><td><span class="badge-type">' + r.record_type + '</span></td><td style="font-family:monospace;font-size:0.85rem;color:#888;">' + r.hash + '</td><td style="color:#9945ff;">$' + r.fee.toFixed(2) + '</td></tr>').join('');
        }

        document.getElementById('hashBtns').addEventListener('click', e => { if (e.target.dataset.view) { currentHashView = e.target.dataset.view; document.querySelectorAll('#hashBtns .filter-btn').forEach(b => b.classList.toggle('active', b.dataset.view === currentHashView)); renderHashChart(currentHashView); } });
        document.getElementById('feeBtns').addEventListener('click', e => { if (e.target.dataset.view) { currentFeeView = e.target.dataset.view; document.querySelectorAll('#feeBtns .filter-btn').forEach(b => b.classList.toggle('active', b.dataset.view === currentFeeView)); renderFeeChart(currentFeeView); } });
        document.getElementById('txBtns').addEventListener('click', e => { if (e.target.dataset.view) { currentTxView = e.target.dataset.view; document.querySelectorAll('#txBtns .filter-btn').forEach(b => b.classList.toggle('active', b.dataset.view === currentTxView)); renderTxChart(currentTxView); } });

        window.addEventListener('DOMContentLoaded', loadMetrics);
        setInterval(loadMetrics, 30000);
    </script>
</body>
</html>
