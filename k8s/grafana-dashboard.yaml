# S4 Ledger — Grafana Dashboard (JSON Model)
# Auto-provisioned via ConfigMap or Grafana provisioning

apiVersion: v1
kind: ConfigMap
metadata:
  name: s4-grafana-dashboard
  namespace: s4-ledger
  labels:
    grafana_dashboard: "true"
data:
  s4-ledger-overview.json: |
    {
      "dashboard": {
        "title": "S4 Ledger — Platform Overview",
        "uid": "s4-overview-v1",
        "tags": ["s4-ledger", "defense", "xrpl"],
        "timezone": "utc",
        "refresh": "30s",
        "panels": [
          {
            "title": "Anchors / Minute",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
            "targets": [
              {"expr": "rate(s4_anchors_total[1m]) * 60", "legendFormat": "anchors/min"}
            ]
          },
          {
            "title": "API Request Rate",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
            "targets": [
              {"expr": "rate(s4_http_requests_total[5m])", "legendFormat": "{{method}} {{endpoint}}"}
            ]
          },
          {
            "title": "Anchor Queue Depth",
            "type": "gauge",
            "gridPos": {"h": 6, "w": 6, "x": 0, "y": 8},
            "targets": [
              {"expr": "s4_anchor_queue_depth"}
            ],
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": 0},
                    {"color": "yellow", "value": 200},
                    {"color": "red", "value": 1000}
                  ]
                }
              }
            }
          },
          {
            "title": "XRPL Validator Health",
            "type": "stat",
            "gridPos": {"h": 6, "w": 6, "x": 6, "y": 8},
            "targets": [
              {"expr": "s4_xrpl_validator_healthy", "legendFormat": "{{validator}}"}
            ]
          },
          {
            "title": "Treasury XRP Balance",
            "type": "stat",
            "gridPos": {"h": 6, "w": 6, "x": 12, "y": 8},
            "targets": [
              {"expr": "s4_treasury_xrp_balance"}
            ]
          },
          {
            "title": "SLS Economy — Fees Collected / Hour",
            "type": "timeseries",
            "gridPos": {"h": 6, "w": 6, "x": 18, "y": 8},
            "targets": [
              {"expr": "rate(s4_sls_fees_collected_total[1h]) * 3600", "legendFormat": "SLS/hr"}
            ]
          },
          {
            "title": "Anchor p95 Latency",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 14},
            "targets": [
              {"expr": "histogram_quantile(0.95, rate(s4_anchor_duration_seconds_bucket[5m]))", "legendFormat": "p95"}
            ]
          },
          {
            "title": "AI Agent Queries / Min",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 14},
            "targets": [
              {"expr": "rate(s4_ai_queries_total[1m]) * 60", "legendFormat": "queries/min"},
              {"expr": "rate(s4_ai_query_errors_total[1m]) * 60", "legendFormat": "errors/min"}
            ]
          },
          {
            "title": "Error Rate by Endpoint",
            "type": "table",
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 22},
            "targets": [
              {"expr": "topk(10, rate(s4_http_errors_total[5m]))", "format": "table"}
            ]
          },
          {
            "title": "Redis Memory & Keys",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 30},
            "targets": [
              {"expr": "redis_memory_used_bytes / 1024 / 1024", "legendFormat": "Memory (MB)"},
              {"expr": "redis_db_keys{db='db0'}", "legendFormat": "Keys"}
            ]
          },
          {
            "title": "Offline Queue Status",
            "type": "stat",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 30},
            "targets": [
              {"expr": "s4_offline_queue_pending", "legendFormat": "Pending"},
              {"expr": "s4_offline_queue_synced", "legendFormat": "Synced"}
            ]
          }
        ]
      }
    }
